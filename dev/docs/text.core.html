---

title: Text core
keywords: fastai
sidebar: home_sidebar

summary: "Basic function to preprocess text before assembling it in a [`DataBunch`](/data.core.html#DataBunch)."
---
<!--


#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: dev/30_text_core.ipynb
# instructions: https://docs.fast.ai/gen_doc_main.html

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Multiprocessing">Multiprocessing<a class="anchor-link" href="#Multiprocessing">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>ProcessPoolExecutor</code>" class="doc_header"><code>class</code> <code>ProcessPoolExecutor</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>ProcessPoolExecutor</code>(<strong><code>max_workers</code></strong>=<em><code>None</code></em>, <strong><code>mp_context</code></strong>=<em><code>None</code></em>, <strong><code>initializer</code></strong>=<em><code>None</code></em>, <strong><code>initargs</code></strong>=<em><code>()</code></em>) :: <a href="/text.core.html#ProcessPoolExecutor"><code>ProcessPoolExecutor</code></a></p>
</blockquote>
<p>This is an abstract base class for concrete asynchronous executors.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>parallel</code>" class="doc_header"><code>parallel</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parallel</code>(<strong><code>func</code></strong>, <strong><code>items</code></strong>, <strong><code>n_workers</code></strong>=<em><code>16</code></em>)</p>
</blockquote>
<p>Applies <code>func</code> in parallel to <code>items</code>, using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">parallel</span><span class="p">(</span><span class="n">add_one</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">parallel</span><span class="p">(</span><span class="n">add_one</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">parallel</span><span class="p">(</span><span class="n">add_one</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>parallel_gen</code>" class="doc_header"><code>parallel_gen</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parallel_gen</code>(<strong><code>items</code></strong>, <strong><code>n_workers</code></strong>=<em><code>16</code></em>, <strong><code>as_gen</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Instantiate <code>cls</code> in <code>n_workers</code> procs &amp; call each on a subset of <code>items</code> in parallel.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>cls</code> is any class with <code>__call__</code>. It will be passed <code>args</code> and <code>kwargs</code> when initialized. Note that <code>n_workers</code> instances of <code>cls</code> are created, one in each process. <code>items</code> are then split in <code>n_workers</code> batches and one is sent to each <code>cls</code>. The function then returns a list of all the results, matching the order of <code>items</code> (if not <code>as_gen</code>) or a generator of tuples of item indices and results (if <code>as_gen</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SleepyBatchFunc</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">k</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.99</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">parallel_gen</span><span class="p">(</span><span class="n">SleepyBatchFunc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Preprocessing-rules">Preprocessing rules<a class="anchor-link" href="#Preprocessing-rules">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following are rules applied to texts before or after it's tokenized.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>spec_add_spaces</code>" class="doc_header"><code>spec_add_spaces</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>spec_add_spaces</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Add spaces around / and #</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;#fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; # fastai&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;/fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; / fastai&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; </span><span class="se">\\</span><span class="s1"> fastai&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>rm_useless_spaces</code>" class="doc_header"><code>rm_useless_spaces</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rm_useless_spaces</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Remove multiple spaces</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">rm_useless_spaces</span><span class="p">(</span><span class="s1">&#39;a  b   c&#39;</span><span class="p">),</span> <span class="s1">&#39;a b c&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>replace_rep</code>" class="doc_header"><code>replace_rep</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_rep</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace repetitions at the character level: cccc -&gt; TK_REP 4 c</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It starts replacing at 3 repetitions of the same character or more.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_rep</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">),</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_rep</span><span class="p">(</span><span class="s1">&#39;aaaa&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{TK_REP}</span><span class="s1"> 4 a &#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>replace_wrep</code>" class="doc_header"><code>replace_wrep</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_wrep</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace word repetitions: word word word word -&gt; TK_WREP 4 word</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It starts replacing at 3 repetitions of the same word or more.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah&#39;</span><span class="p">),</span> <span class="s1">&#39;ah ah&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 3 ah &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah   ah  ah&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah ah &#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah  &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah ah.&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah .&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ahi&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39;ah ah ahi&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>fix_html</code>" class="doc_header"><code>fix_html</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fix_html</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>Various messy things we've seen in documents</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;#39;bli#146;&#39;</span><span class="p">),</span> <span class="s2">&quot;&#39;bli&#39;&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;Sarah amp; Duck...&#39;</span><span class="p">),</span> <span class="s1">&#39;Sarah &amp; Duck …&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;a nbsp; #36;&#39;</span><span class="p">),</span> <span class="s1">&#39;a   $&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot; &lt;unk&gt;&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39;&quot; </span><span class="si">{UNK}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;quot;  @.@  @-@ &#39;</span><span class="p">),</span> <span class="s2">&quot;&#39; .-&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;&lt;br /&gt;text</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">text</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>replace_all_caps</code>" class="doc_header"><code>replace_all_caps</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_all_caps</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace tokens in ALL CAPS by their lower version and add <code>TK_UP</code> before.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I&#39;M SHOUTING&quot;</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{TK_UP}</span><span class="s2"> i&#39;m </span><span class="si">{TK_UP}</span><span class="s2"> shouting&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I&#39;m speaking normally&quot;</span><span class="p">),</span> <span class="s2">&quot;I&#39;m speaking normally&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I am speaking normally&quot;</span><span class="p">),</span> <span class="s2">&quot;i am speaking normally&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>replace_maj</code>" class="doc_header"><code>replace_maj</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_maj</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace tokens in ALL CAPS by their lower version and add <code>TK_UP</code> before.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_maj</span><span class="p">(</span><span class="s2">&quot;Jeremy Howard&quot;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{TK_MAJ}</span><span class="s1"> jeremy </span><span class="si">{TK_MAJ}</span><span class="s1"> howard&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_maj</span><span class="p">(</span><span class="s2">&quot;I don&#39;t think there is any maj here&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;i don&#39;t think there is any maj here&quot;</span><span class="p">),)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>lowercase</code>" class="doc_header"><code>lowercase</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lowercase</code>(<strong><code>t</code></strong>, <strong><code>add_bos</code></strong>=<em><code>True</code></em>, <strong><code>add_eos</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Converts <code>t</code> to lowercase</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>replace_space</code>" class="doc_header"><code>replace_space</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_space</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace embedded spaces in a token with unicode line char to allow for split/join</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tokenizing">Tokenizing<a class="anchor-link" href="#Tokenizing">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A tokenizer is a class that must implement a <code>pipe</code> method. This <code>pipe</code> method receives a generator of texts and must return a generator with their tokenized versions. Here is the most basic example:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>BaseTokenizer</code>" class="doc_header"><code>class</code> <code>BaseTokenizer</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>BaseTokenizer</code>(<strong><code>split_char</code></strong>=<em><code>' '</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Basic tokenizer that just splits on spaces</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok</span> <span class="o">=</span> <span class="n">BaseTokenizer</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="o">.</span><span class="n">pipe</span><span class="p">([</span><span class="s2">&quot;This is a text&quot;</span><span class="p">]):</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;This&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">])</span>
<span class="n">tok</span> <span class="o">=</span> <span class="n">BaseTokenizer</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="o">.</span><span class="n">pipe</span><span class="p">([</span><span class="s2">&quot;This is a text&quot;</span><span class="p">]):</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;This is a te&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>SpacyTokenizer</code>" class="doc_header"><code>class</code> <code>SpacyTokenizer</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>SpacyTokenizer</code>(<strong><code>lang</code></strong>=<em><code>'en'</code></em>, <strong><code>special_toks</code></strong>=<em><code>None</code></em>, <strong><code>batch_size</code></strong>=<em><code>5000</code></em>)</p>
</blockquote>
<p>Spacy tokenizer for <code>lang</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok</span> <span class="o">=</span> <span class="n">SpacyTokenizer</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="o">.</span><span class="n">pipe</span><span class="p">([</span><span class="s2">&quot;This isn&#39;t the easiest text.&quot;</span><span class="p">]):</span> 
    <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;This&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;easiest&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>apply_rules</code>" class="doc_header"><code>apply_rules</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>apply_rules</code>(<strong><code>items</code></strong>, <strong><code>rules</code></strong>)</p>
</blockquote>
<p>Returns a generator that apply <code>rules</code>  to <code>items</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">apply_rules</span><span class="p">([</span><span class="s2">&quot;This is a text&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">replace_maj</span><span class="p">]):</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{TK_MAJ}</span><span class="s2"> this is a text&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>TokenizeBatch</code>" class="doc_header"><code>class</code> <code>TokenizeBatch</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>TokenizeBatch</code>(<strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>post_rules</code></strong>=<em><code>None</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>A wrapper around <code>tok_func</code> to apply <code>rules</code> and tokenize in parallel</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">([</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">]),</span> <span class="p">[[</span><span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;problem&#39;</span><span class="p">]])</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">(</span><span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="p">[],</span> <span class="n">split_char</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">([</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">]),</span> <span class="p">[[</span><span class="s1">&#39;This▁isn&#39;</span><span class="p">,</span> <span class="s1">&#39;t▁a▁problem&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The main function that will be called during one of the processes handling tokenization. It will create an instance of a tokenizer with <code>tok_func</code> and <code>tok_kwargs</code> at init, then iterate through the <code>batch</code> of texts, apply them <code>rules</code> and tokenize them.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;this is a text&quot;</span><span class="p">,</span> <span class="s2">&quot;this is another text&quot;</span><span class="p">]</span>
<span class="n">tok</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">(</span><span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">texts</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])],[[</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;another&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>tokenize1</code>" class="doc_header"><code>tokenize1</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize1</code>(<strong><code>text</code></strong>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>post_rules</code></strong>=<em><code>None</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize one <code>text</code> with an instance of <code>tok_func</code> and some <code>rules</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">tokenize1</span><span class="p">(</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">),</span>
        <span class="p">[</span><span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;problem&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tokenize1</span><span class="p">(</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">,</span> <span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="p">[],</span> <span class="n">split_char</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span><span class="p">),</span>
        <span class="p">[</span><span class="s1">&#39;This▁isn&#39;</span><span class="p">,</span> <span class="s1">&#39;t▁a▁problem&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>parallel_tokenize</code>" class="doc_header"><code>parallel_tokenize</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parallel_tokenize</code>(<strong><code>items</code></strong>, <strong><code>tok_func</code></strong>, <strong><code>rules</code></strong>, <strong><code>as_gen</code></strong>=<em><code>False</code></em>, <strong><code>n_workers</code></strong>=<em><code>16</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Calls a potential setup on <code>tok_func</code> before launching <a href="/text.core.html#TokenizeBatch"><code>TokenizeBatch</code></a> in parallel</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tokenize-texts-in-files">Tokenize texts in files<a class="anchor-link" href="#Tokenize-texts-in-files">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Preprocessing function for texts in filenames. Tokenized texts will be saved in a similar fashion in a directory suffixed with <code>_tok</code> in the parent folder of <code>path</code> (override with <code>output_dir</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Path.read</code>" class="doc_header"><code>Path.read</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Path.read</code>()</p>
</blockquote>
<p>Read the content of <code>fname</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Path.write</code>" class="doc_header"><code>Path.write</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Path.write</code>(<strong><code>txt</code></strong>)</p>
</blockquote>
<p>Write <code>txt</code> to <code>self</code>, creating directories as needed</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>tokenize_folder</code>" class="doc_header"><code>tokenize_folder</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_folder</code>(<strong><code>path</code></strong>, <strong><code>extensions</code></strong>=<em><code>None</code></em>, <strong><code>include</code></strong>=<em><code>None</code></em>, <strong><code>output_dir</code></strong>=<em><code>None</code></em>, <strong><code>n_workers</code></strong>=<em><code>16</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize text files in <code>path</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The result will be in <code>output_dir</code> (defaults to a folder in the same parent directory as <code>path</code>, with <code>_tok</code> added to <code>path.name</code>) with the same structure as in <code>path</code>. Tokenized texts for a given file will be in the file having the same name in <code>output_dir</code>. Additionally, a file with a .len suffix contains the number of tokens and the count of all words is stored in <code>output_dir/counter.pkl</code>.</p>
<p><code>extensions</code> will default to <code>['.txt']</code> and all text files in <code>path</code> are treated unless you specify a list of folders in <code>include</code>. <code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core.html#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># TODO: test include option</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span> 
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="n">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{d}</span><span class="s2"> </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">tokenize_folder</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">outp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;tmp_tok&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">outp</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="n">outp</span><span class="o">/</span><span class="n">d</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.len&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
        <span class="n">test_eq</span><span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="n">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]))</span>
        <span class="n">test_eq</span><span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="n">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.len&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;10&#39;</span><span class="p">)</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tokenize-texts-in-a-dataframe">Tokenize texts in a dataframe<a class="anchor-link" href="#Tokenize-texts-in-a-dataframe">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>tokenize_df</code>" class="doc_header"><code>tokenize_df</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_df</code>(<strong><code>df</code></strong>, <strong><code>text_cols</code></strong>, <strong><code>n_workers</code></strong>=<em><code>16</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>mark_fields</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize texts in <code>df[text_cols]</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This function returns a new dataframe with the same non-text columns, a colum named text that contains the tokenized texts and a column named text_lengths that contains their respective length. It also returns a counter of all words see to quickly build a vocabulary afterward.</p>
<p><code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core.html#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer. If <code>mark_fields</code> isn't specified, it defaults to <code>False</code> when there is a single text column, <code>True</code> when there are several. In that case, the texts in each of those columns are joined with <code>FLD</code> markes followed by the number of the field.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;xxbos&#39;, &#39;xxmaj&#39;, &#39;this&#39;, &#39;is&#39;, &#39;an&#39;, &#39;example&#39;, &#39;of&#39;, &#39;text&#39;, &#39;0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))},</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">,</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">tokenize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_cols</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;text_lengths&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span>
        <span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">])</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;text_lengths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>tokenize_csv</code>" class="doc_header"><code>tokenize_csv</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_csv</code>(<strong><code>fname</code></strong>, <strong><code>text_cols</code></strong>, <strong><code>outname</code></strong>=<em><code>None</code></em>, <strong><code>n_workers</code></strong>=<em><code>4</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>mark_fields</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>header</code></strong>=<em><code>'infer'</code></em>, <strong><code>chunksize</code></strong>=<em><code>None</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize texts in the <code>text_cols</code> of the csv <code>fname</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The result will be written in a new csv file in <code>outname</code> (defaults to the same as <code>fname</code> with the suffix <code>_tok.csv</code>) and will have the same header as the original file, the same non-text columns, a text and a text_lengths column as described in <a href="/text.core.html#tokenize_df"><code>tokenize_df</code></a>.</p>
<p><code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core.html#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer. If <code>mark_fields</code> isn't specified, it defaults to <code>False</code> when there is a single text column, <code>True</code> when there are several. In that case, the texts in each of those columns are joined with <code>FLD</code> markes followed by the number of the field.</p>
<p>The csv file is opened with <code>header</code> and optionally with blocks of <code>chunksize</code> at a time. If this argument is passed, each chunk is processed independtly and saved in the output file to save memory usage.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sentencepiece">Sentencepiece<a class="anchor-link" href="#Sentencepiece">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">eu_langs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">,</span> <span class="s2">&quot;da&quot;</span><span class="p">,</span> <span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="s2">&quot;es&quot;</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">,</span> <span class="s2">&quot;fi&quot;</span><span class="p">,</span> <span class="s2">&quot;fr&quot;</span><span class="p">,</span> <span class="s2">&quot;ga&quot;</span><span class="p">,</span> <span class="s2">&quot;hr&quot;</span><span class="p">,</span> <span class="s2">&quot;hu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;it&quot;</span><span class="p">,</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span><span class="s2">&quot;lv&quot;</span><span class="p">,</span><span class="s2">&quot;mt&quot;</span><span class="p">,</span><span class="s2">&quot;nl&quot;</span><span class="p">,</span><span class="s2">&quot;pl&quot;</span><span class="p">,</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span><span class="s2">&quot;ro&quot;</span><span class="p">,</span><span class="s2">&quot;sk&quot;</span><span class="p">,</span><span class="s2">&quot;sl&quot;</span><span class="p">,</span><span class="s2">&quot;sv&quot;</span><span class="p">]</span> <span class="c1"># all European langs</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>SentencePieceTokenizer</code>" class="doc_header"><code>class</code> <code>SentencePieceTokenizer</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/30_text_core.ipynb" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>SentencePieceTokenizer</code>(<strong><code>lang</code></strong>=<em><code>'en'</code></em>, <strong><code>special_toks</code></strong>=<em><code>None</code></em>, <strong><code>sp_model</code></strong>=<em><code>None</code></em>, <strong><code>vocab_sz</code></strong>=<em><code>None</code></em>, <strong><code>max_vocab_sz</code></strong>=<em><code>30000</code></em>, <strong><code>model_type</code></strong>=<em><code>'unigram'</code></em>, <strong><code>char_coverage</code></strong>=<em><code>None</code></em>, <strong><code>cache_dir</code></strong>=<em><code>'tmp'</code></em>)</p>
</blockquote>
<p>Spacy tokenizer for <code>lang</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))},</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">,</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">tokenize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_cols</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">tok_func</span><span class="o">=</span><span class="n">SentencePieceTokenizer</span><span class="p">,</span> <span class="n">vocab_sz</span><span class="o">=</span><span class="mi">34</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>label</th>
      <th>text</th>
      <th>text_lengths</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 0</td>
      <td>31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 1</td>
      <td>31</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 2</td>
      <td>31</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 3</td>
      <td>31</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 4</td>
      <td>31</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 5</td>
      <td>31</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 6</td>
      <td>31</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 7</td>
      <td>31</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 8</td>
      <td>31</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9</td>
      <td>▁xxbos ▁xxmaj ▁ t h i s ▁ i s ▁ a n ▁ e x a m p l e ▁ o f ▁ t e x t ▁ 9</td>
      <td>31</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
</div>
 

